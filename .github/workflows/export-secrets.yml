name: Export Secrets to Artifact

on:
  workflow_dispatch:

env:
  PREFIX_SECRETS: 'SECRETS_'
jobs:
  parse-repo-name:
    name: Parse Repository Name
    runs-on: windows-latest
    outputs:
      owner: ${{ steps.parse-repo-name.outputs.owner }}
      repository: ${{ steps.parse-repo-name.outputs.repository }}
    steps:
      - name: Parse Repository Name
        id: parse-repo-name
        uses: martins-vds/gh-migration-scripts/composite-actions/parse-repository-name@main
        with:
          repository: ${{ github.repository }}
  export-repo-secrets:
    name: Export Repo Secrets
    runs-on: windows-latest
    needs: [parse-repo-name]
    steps:
      - name: Export Repo Secrets
        uses: martins-vds/gh-migration-scripts/composite-actions/export-secrets@main        
        env:
          '${{ env.PREFIX_SECRETS }}MY_SECRET': ${{ secrets.MY_SECRET }}
        with:
          secrets-prefix: ${{ env.PREFIX_SECRETS }}
          artifact-name: 'secrets-${{ needs.parse-repo-name.outputs.owner }}-${{ needs.parse-repo-name.outputs.repository }}'
  export-env-secrets:
    name: Export Environment Secrets from Production
    runs-on: windows-latest
    needs: [parse-repo-name]
    environment: production
    steps:
      - name: Export Environment Secrets
        uses: martins-vds/gh-migration-scripts/composite-actions/export-secrets@main               
        env:
          '${{ env.PREFIX_SECRETS }}MY_PROD_SECRET': ${{ secrets.MY_PROD_SECRET }}
        with:
          secrets-prefix: ${{ env.PREFIX_SECRETS }}
          artifact-name: 'secrets-${{ needs.parse-repo-name.outputs.owner }}-${{ needs.parse-repo-name.outputs.repository }}-production'
          environment-name: production
  merge-secrets:
    name: Merge Secrets
    runs-on: windows-latest
    needs: [ parse-repo-name, export-repo-secrets, export-env-secrets]
    steps:
      - uses: actions/download-artifact@v3.0.2
        with:
          path: ${{ runner.temp }}/secrets/all
      - run: |
          New-Item ${{ runner.temp }}/secrets/merged -ItemType Directory -Force
          Get-ChildItem -Path "${{ runner.temp }}\secrets\all" -Include *.csv -Recurse | Select-Object -ExpandProperty FullName | Import-Csv | Export-Csv "${{ runner.temp }}/secrets/merged/secrets-${{ job.parse-repo-name.outputs.owner }}-${{ job.parse-repo-name.outputs.repository }}-merged.csv" -UseQuotes AsNeeded -NoTypeInformation -Append -Encoding utf8
      - uses: actions/upload-artifact@v3.1.2
        with:
          name: secrets-${{ needs.parse-repo-name.outputs.owner }}-${{ needs.parse-repo-name.outputs.repository }}-merged
          path: ${{ runner.temp }}/secrets/merged/secrets-${{ needs.parse-repo-name.outputs.owner }}-${{ needs.parse-repo-name.outputs.repository }}-merged.csv